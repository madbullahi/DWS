---
title: "Wastewater bacterial removal analysis"
output: rmarkdown::github_documemt
author: "Muhammad"
---



```{r}
# load libraries
library(tidyverse)
library(qiime2R)
library(microbiome)
library(DT)
library(data.table)
library(ggpubr)
library(vegan)
library(DESeq2)
library(phyloseq)
```

```{r}

# convert qiime2 artifact to phyloseq object
ps_ww <- qza_to_phyloseq(
  features = "filtered_table.qza",
  tree = "insertion-tree.qza","taxonomy.qza",
  metadata = "Metadata.tsv"
)

```


```{r}
ps_ww

```

```{r}
# inspect the phyloseq object
summary(sample_sums(ps_ww))
```

```{r}
set.seed(123)
# rarefy the data to min. reads per sample

ps_ww_rare <- rarefy_even_depth(ps_ww, rngseed = 123, sample.size = 30007, replace = TRUE, trimOTUs = TRUE, verbose = TRUE)
```

```{r}
# inspect the rarefied data
summary(sample_sums(ps_ww_rare))
```

```{r}
table(tax_table(ps_ww_rare)[, "Phylum"], exclude = NULL)
```

```{r}
# if any of the phylum has only one feature, consider removing it
ww_rare <- subset_taxa(ps_ww_rare, !is.na(Phylum) & !Phylum %in% c("Nitrospirota", "Fibrobacterota", "Planctomycetota", "NA"))

ww_rare 
```

```{r}
#compute the prevalence of each feature and store in a data frame
prevdf_ww <- apply(X = otu_table(ww_rare),
                   MARGIN = ifelse(taxa_are_rows(ww_rare), yes = 1,   no= 2),
                   FUN = function(OTU) {sum(OTU > 0)})
```

```{r}
# Add taxonomy and total read counts to the data frame.
prevdf_ww <- data.frame(Prevalence = prevdf_ww,
                        TotalAbundance = taxa_sums(ww_rare),
                        tax_table(ww_rare))

prevdf_ww
```

```{r}
# investigate low prevalence/abundance features and subset them out
plyr::ddply(prevdf_ww, "Phylum", function(df1) {
  data.frame(mean_prevalence = mean(df1$Prevalence), total_abundance = sum(df1$ TotalAbundance, na.rm = T), stringsAsFactors = F)
})
```

```{r}
# Define prevalence and abundance thresholds
set.seed(123)
prevalence_threshold <- 0.50 * nsamples(ww_rare)

prevalence_threshold
```

```{r}
# execute the prevalence filter
keep_taxa <- rownames(prevdf_ww)[prevdf_ww$Prevalence >= prevalence_threshold]

length(keep_taxa)
```

```{r}
ww_rare.2 = prune_taxa(keep_taxa, ww_rare)
ww_rare.2
```

```{r}
merge_less_than_top_ww <- function(ww_rare.2, top = 10) { transformed <- transform_sample_counts(ww_rare.2, function(OTU) OTU/sum(OTU)) 
otu.table <- as.data.frame(otu_table(transformed))
otu.sort <- otu.table[order(rowMeans(otu.table), decreasing = TRUE),]
otu.list <- row.names(otu.sort[(top + 1):nrow(otu.sort),])
merged <- merge_taxa(transformed, otu.list, 1)
for (i in 1:dim(tax_table(merged))[1]){
  if (is.na(tax_table(merged)[i,2])){
    taxa_names(merged)[i] <- "Other"
    tax_table(merged)[i, 1:6] <- "other"
  }
}
return(merged) 
}
```

```{r}
ww_Gen <- tax_glom(ww_rare.2, taxrank = "Genus")
ww_Gen
```

```{r}
ww_Gen_10 <- merge_less_than_top_ww(ww_Gen, top = 10)
ww_Gen_10
```

```{r}
# convert to dataframe
tax_rel_abun_pf_gen_top10 <- psmelt(ww_Gen_10) %>%
  filter(Abundance > 0) %>%
  arrange(Genus)

tax_rel_abun_pf_gen_top10
```
```{r}
write.csv(tax_rel_abun_pf_gen_top10, "tax_rel_abun_pf_gen_top10.csv")
```


```{r}
WW<- ggplot(
  tax_rel_abun_pf_gen_top10, aes(x = Day, y = Abundance, fill = Genus)
)+
  facet_grid(~Treatment, scales = "free")+
  geom_bar(stat = "identity", position = "fill")+
  labs(x="Day", y="Rel. Abun", title = "Genus relative abundance") +
   theme(
    axis.text.x = element_text(size = 10, 
    angle = 90, vjust = 0.5, hjust = 1),
    axis.text.y = element_text(size = 8),
    legend.text = element_text(size = 8),
    strip.text = element_text(size = 8)
  )
```

```{r}
WW
```
```{r}
# Filter the data for Day 3 only
day3_data <- tax_rel_abun_pf_gen_top10 %>%
  filter(Day == 'D3')

# Find the top ten genera based on their mean abundance on Day 3
top_genera <- day3_data %>%
  group_by(Genus) %>%
  summarise(mean_abundance = mean(Abundance)) %>%
  top_n(10, mean_abundance) %>%
  pull(Genus)

# Filter the Day 3 data to include only the top ten genera
day3_top_genera_data <- day3_data %>%
  filter(Genus %in% top_genera)

# Create the bar plot for Day 3 with the top ten genera
WW <- ggplot(day3_top_genera_data, aes(x = Genus, y = Abundance, fill = Genus)) +
  facet_grid(~Treatment, scales = "free_y") +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Genus", y = "Relative Abundance", title = "Top Ten Genera Relative Abundance on Day 3") +
  theme(
    axis.text.x = element_text(size = 10, angle = 90, vjust = 0.5, hjust = 1),
    axis.text.y = element_text(size = 8),
    legend.text = element_text(size = 8),
    strip.text = element_text(size = 8)
  ) #+
  #scale_y_continuous(limits = c(0, 600))  # Set y-axis limits

# Print the bar plot
WW

```

```{r}

# Create the bar plot for Day 3 with the top ten genera
WW <- ggplot(day3_top_genera_data, aes(x = Genus, y = Abundance, fill = Genus)) +
  facet_grid(~Treatment, scales = "free_y") +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Genus", y = "Relative Abundance", title = "Top Ten Genera Relative Abundance on Day 3") +
  theme(
    axis.text.x = element_text(size = 10, angle = 90, vjust = 0.5, hjust = 1),
    axis.text.y = element_text(size = 8),
    legend.text = element_text(size = 8),
    strip.text = element_text(size = 8)
  ) +
  coord_cartesian(ylim = c(0, 1.0))  # Adjust visible y-axis range to 0 to 1.0 without clipping data

# Print the bar plot
WW
```
```{r}
library(dplyr)
library(ggplot2)
library(forcats)

# Assuming 'tax_rel_abun_pf_gen_top10' is your data frame and it contains 'Day', 'Treatment', 'Genus', and 'Abundance' columns

# Filter the data for Day 3 only
day3_data <- tax_rel_abun_pf_gen_top10 %>%
  filter(Day == 'D3')

# Reorder the 'Genus' factor levels based on the sum of 'Abundance', with "other" first
day3_data <- day3_data %>%
  mutate(Genus = fct_reorder(Genus, Abundance, .fun = sum, .desc = TRUE)) %>%
  mutate(Genus = fct_relevel(Genus, "other", after = Inf))  # Place "other" last

# Create the bar plot for Day 3 with the reordered genera
WW <- ggplot(day3_data, aes(x = Genus, y = Abundance, fill = Genus)) +
  facet_grid(~Treatment, scales = "free_y") +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Genus", y = "Relative Abundance", title = "Top Ten Genera Relative Abundance on Day 3") +
  theme(
    axis.text.x = element_text(size = 10, angle = 90, vjust = 0.5, hjust = 1),
    axis.text.y = element_text(size = 8),
    legend.text = element_text(size = 8),
    strip.text = element_text(size = 8)
  ) +
  coord_cartesian(ylim = c(0, 1.0))  # Adjust visible y-axis range to 0 to 1.0 without clipping data

# Print the bar plot
WW


```
```{r}

library(dplyr)
library(ggplot2)
library(forcats)

# Assuming 'tax_rel_abun_pf_gen_top10' is your data frame and it contains 'Day', 'Treatment', 'Genus', and 'Abundance' columns

# Filter the data for Day 3 only
day3_data <- tax_rel_abun_pf_gen_top10 %>%
  filter(Day == 'D3')

# Reorder the 'Genus' factor levels based on the sum of 'Abundance', with "other" first
day3_data <- day3_data %>%
  mutate(Genus = fct_reorder(Genus, Abundance, .fun = sum, .desc = TRUE)) %>%
  mutate(Genus = fct_relevel(Genus, "other", after = Inf))  # Place "other" last

# Create a stacked percentage bar plot for Day 3
WW <- ggplot(day3_data, aes(x = Treatment, y = Abundance, fill = Genus)) +
  geom_bar(stat = "identity", position = "fill") +  # Use position="fill" to scale each bar to sum to 1 (100%)
  labs(x = "Treatment", y = "Relative Abundance (%)", title = "Taxonomic Composition on Day 3") +
  scale_y_continuous(labels = scales::percent) +  # Convert y-axis to percentage
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 12, angle = 0, vjust = 0.5, hjust = 0.5),  # Increase x-axis text size
    axis.text.y = element_text(size = 12),  # Increase y-axis text size
    legend.text = element_text(size = 10),  # Increase legend text size
    strip.text = element_text(size = 12)  # Increase facet label text size
  )

# Print the bar plot
WW

```



```{r}
tax_rel_abun_pf_gen_top10 %>%
  mutate(Genus_pf = case_when(is.na(Genus) ~ "Other", TRUE ~ as.character(Genus))) %>% #this part changes everything that's uncharacterised to be called other
  #filter(Abundance > 0.01) %>% # filter out anything less than 2% abundance
  ggplot(aes(Day,
             Genus_pf, color =
               Genus_pf)) +
  geom_point(aes(size = 
                   Abundance, 
                 fill = Genus_pf)) + #when size = Abundance, it changes the size to depend on the relative abundance in the dataframe.
facet_grid(~Treatment) +
  labs(x="Day", y="Rel. Abun", title = "Genus relative abundance") +
   theme(
    axis.text.x = element_text(size = 10, 
    angle = 90, vjust = 0.5, hjust = 1),
    axis.text.y = element_text(size = 8),
    legend.text = element_text(size = 8),
    strip.text = element_text(size = 8)
  )

```

```{r}
#class taxa
ww_Class <- tax_glom(ww_rare.2, taxrank = "Class")
ww_Class

```

```{r}
library(MicrobiotaProcess)
library(UpSetR)
library(VennDiagram)
```

```{r}
upsetda <- get_upset(obj = ww_rare.2, factorNames= "Treatment")
upsetda
```

```{r}
U_ww <- upset(upsetda, sets=unique(as.vector(sample_data(ww_rare.2)$Treatment)), 
      sets.bar.color = "#56B4E9",
      order.by = "freq", 
      empty.intersections = "on")
U_ww

```

```{r}
vennlist <- get_vennlist(obj = ww_rare.2, factorNames = "Treatment")
```

```{r}
vennp <- venn.diagram(vennlist,
                      height = 5,
                      width = 5,
                      filename = NULL,
                      fill = c("#00AED7", "#FD9347"),
                      cat.col = c("#00AED7", "#FD9347"),
                      alpha = c(0.5, 0.5),
                      fontfamily = "serif",
                      fontface = "bold",
                      cex = 1,
                      cat.default.pos = "outer",
                      cat.dist = 0.1,
                      margin = 0.1,
                      lwd = 3,
                      lty = "dotted",
                      imagetype = "png")
grid.draw(vennp)

```

```{r}

library(grDevices)
pdf(file = "venn.pdf")
grid.draw(vennp)
dev.off()
```

```{r}
        
  #Calculate the mean and standard error
summary_data <- tax_rel_abun_pf_gen_top10 %>%
  group_by(Day, Treatment, Genus) %>%
  summarise(mean = mean(Abundance),
            sd = sd(Abundance),
            se = sd(Abundance)/sqrt(n()))
```

```{r}

pd <- position_dodge(width = 0.5)


```


```{r}
#create the line plot with standard error
ggplot(summary_data, aes(x = Day, y = mean, colour = Treatment, group = Treatment)) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), width = 0.1, position = pd) +
  geom_point(position = pd) +
  facet_wrap(~Genus, scales = "free") +
  labs(x="Day", y="Rel. Abun", title = "Genus relative abundance") +
   theme(
    axis.text.x = element_text(size = 10, 
    angle = 90, vjust = 0.5, hjust = 1),
    axis.text.y = element_text(size = 8),
    legend.text = element_text(size = 8),
    strip.text = element_text(size = 8)
  )
```
```{r}
glom<- tax_glom(ww_rare.2, taxrank = "Genus")
perct <- psmelt(glom)
perct
```

```{r}
# create the data for control and treatment
control_data <- subset(perct, Treatment == "Wastewater_Control")
treatment_data <- subset(perct, Treatment == "Wastewater_Treatment")
```

```{r}

control_ASV_abundance <- perct$Abundance[perct$Treatment == "Wastewater_Control"]
treatment_ASV_abundance <- perct$Abundance[perct$Treatment == "Wastewater_Daphnia"]
```

```{r}
merged_data <- rbind(control_ASV_abundance, treatment_ASV_abundance)
```

```{r}
asv_data_se <- perct %>%
  group_by(Day, Treatment ) %>%
  summarise(mean = mean(Abundance),                               
            sd = sd(Abundance),
            se = sd(Abundance)/sqrt(n()))
```
```{r}

asv_data_se
```



```{r}
# create the line plot with standard error
ggplot(data = asv_data_se, aes(x = Day, y = mean , group = Treatment, color = Treatment)) +  
 #geom_line(position = pd)+
  #geom_point(position = pd)+ 
 geom_bar(stat = "identity", position = pd, color = 'black', fill = "grey") +
 geom_errorbar(data = asv_data_se, aes(ymin = mean - se, ymax = mean + se), position = pd, width = 0.1) +  # Add error bars
  labs(x = "Day", y = "ASV Counts") +  # Add axis labels
  #scale_color_manual(values = c("blue", "red")) +
 # scale_fill_manual(values = c("Wastewater_Control"= "skyblue", "Wastewater_Daphnia" = "salmon")) +
 # geom_text(aes(label = paste0(format(round(mean, 4), nsmall = 1), "%"), y= mean), position = pd, vjust = -0.5) +
  theme_minimal()# Customize line colors
```




```{r}
# Filter the data for Day 3 only
day3_data <- asv_data_se[asv_data_se$Day == 'D3', ]

# Calculate the percentage difference in means
wastewater_daphnia_mean <- day3_data$mean[day3_data$Treatment == "Wastewater_Daphnia"]
wastewater_control_mean <- day3_data$mean[day3_data$Treatment == "Wastewater_control"]
percent_diff <- (wastewater_control_mean - wastewater_daphnia_mean) / wastewater_control_mean * 100

# Create the plot for Day 3
ggplot(data = day3_data, aes(x = Treatment, y = mean, fill = Treatment)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.5) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), position = position_dodge(width = 0.9), width = 0.2) +
  labs(x = "Treatment", y = "ASV Counts", title = paste0("Day 3: ", round(percent_diff, 2), "% Difference")) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_minimal()

```


```{r}

# Calculate the percentage difference in means
wastewater_daphnia_mean <- day3_data$mean[day3_data$Treatment == "Wastewater_Daphnia"]
wastewater_control_mean <- day3_data$mean[day3_data$Treatment == "Wastewater_control"]
percent_diff <- (wastewater_control_mean - wastewater_daphnia_mean) / wastewater_control_mean * 100

# Create the plot for Day 3
ggplot(data = day3_data, aes(x = Treatment, y = mean, fill = Treatment)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.5) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), position = position_dodge(width = 0.9), width = 0.2) +
  labs(x = "Treatment", y = "ASV Counts" ) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_minimal()

```




```{r}

# Create the plot for Day 3 with specified y-axis limits
ggplot(data = day3_data, aes(x = Treatment, y = mean, color = Treatment, group = 1)) +
  geom_line() +  # Add lines
  geom_point(size = 4) +  # Add points to show individual data points
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), width = 0.2) +  # Add error bars
  labs(x = "Treatment", y = "ASV Counts", title = paste0("Day 3: ", round(percent_diff, 2), "% Difference")) +
  theme_minimal() +
  #scale_color_manual(values = c("Wastewater_Daphnia" = "blue", "Wastewater_control" = "red")) +  # Customize colors
  scale_y_continuous(limits = c(0, 600)) +# Set y-axis limits
theme_minimal() +
  theme(
    axis.text.x = element_text(size = 12, angle = 0, vjust = 0.5, hjust = 0.5),  # Increase x-axis text size
    axis.text.y = element_text(size = 12),  # Increase y-axis text size
    legend.text = element_text(size = 10),  # Increase legend text size
    strip.text = element_text(size = 12))  # Increase facet label text size
```



```{r}
# extract the bactterial count data from the phyolseq object

count_matrix <- as.matrix(otu_table(ww_rare.2))
count_matrix

```

```{r}
# Separate samples into two groups based on the presence of Daphnia

sample_data <- as.data.frame(sample_data(ww_rare.2))
daphnia_samples <- sample_data$Treatment == "Wastewater_Daphnia"
control_samples <- sample_data$Treatment == "Wastewater_Control"

```

```{r}
# Calculate the total bacterial count for each sample.

total_count <- colSums(count_matrix)
total_count

```

```{r}

# Calculate the mean bacterial count for each samople group.

mean_daphnia_count <- mean(total_count[daphnia_samples])
mean_control_count <- mean(total_count[control_samples])

```

```{r}
# Calculate the percentage for each bacteria removed by Daphnia.

percentage_removed <- (mean_control_count - mean_daphnia_count) / mean_control_count * 100
```

```{r}
# Print the result.

cat("Percentage of bacteria removed by Daphnia: ", round(percentage_removed, 2), "%\n")

```

```{r}
library(ggplot2)

# Extract the bacterial count data from the phyloseq object
count_matrix <- as.matrix(otu_table(ww_rare.2))

# Separate samples into two groups based on the presence of Daphnia
sample_data <- as.data.frame(sample_data(ww_rare.2))
sample_data$Daphnia <- ifelse(sample_data$Treatment == "With Daphnia", "With Daphnia", "Without Daphnia")

# Calculate the total bacterial count for each sample
sample_data$Total_Count <- colSums(count_matrix)

# Create a box plot
ggplot(sample_data, aes(x = Daphnia, y = Total_Count)) +
  geom_boxplot() +
  labs(x = "Treatment", y = "Total Bacterial Count") +
  theme_minimal()

# Create a histogram with separate panels for each group
ggplot(sample_data, aes(x = Total_Count)) +
  geom_histogram(bins = 30) +
  facet_wrap(~ Daphnia, ncol = 1) +
  labs(x = "Total Bacterial Count", y = "Frequency") +
  theme_minimal()

```

```{r}

# Calculate the IQR and outlier threshold for the "Without Daphnia" group
without_daphnia_counts <- sample_data$Total_Count[sample_data$Daphnia == "Without Daphnia"]
Q1 <- quantile(without_daphnia_counts, 0.25)
Q3 <- quantile(without_daphnia_counts, 0.75)
IQR <- Q3 - Q1
outlier_threshold <- Q3 + 1.5 * IQR

# Identify the outlier samples
outlier_samples <- sample_data$Sample[sample_data$Daphnia == "Without Daphnia" & sample_data$Total_Count > outlier_threshold]

# Print the outlier samples
print(outlier_samples)

```

*********Merged AVS counts with Sequence Data*********

```{r}
#Read in the ASV sequence data.
asv_seqs <- readLines("dna-sequences-250.fasta")



```


```{r}
#Read in the ASV count table 
asv_tab <- read.table("feature-table-250.tsv", header=T, row.names=1)

```


```{r}
# Get the ASV IDs

asv_ids <- paste0(">", row.names(asv_tab))

```

```{r}
# Make a sequence list by combining the IDs and sequences.

#asv_list <- data.frame(ASV = asv_ids, Sequence = asv_seqs)
asv_list <- data.frame(ASV = asv_ids, Sequence = asv_seqs[1:length(asv_ids)])


```

```{r}


# Write out the sequence list to a file.

write.table(asv_list, "ASV_sequence_list.txt", sep = "\t", quote = FALSE, row.names = FALSE, col.names = TRUE)

```








""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
""""Wasteswater Microbiome Analysis""""


"""Fresh Analysis"""""""""""""""""""""""""""""""""""""


# Initial Sample QC Check
```{r}

metadata <- read.csv("MetadataWastewater.csv")
stats <-  read_tsv("read-stats.tsv", show_col_types = FALSE)


```

```{r}

head(metadata)

head(stats)

```

```{r}
#lets give the stats dataframe column names

colnames(stats) = c("sample.id", "input", "filtered","reads_passed-filter", "denoised", "merged", "percentage_merged", "non-chimeric", "percentage_non-chimeric")

```

```{r}
head(stats)

```


```{r}

library(tidyverse)
library(dplyr)
```


```{r}

#join the two dataframes.

ww_data <- left_join(metadata, stats)
ww_data

# save the joined data to a file.

write.csv(ww_data, "ww_data.csv")


```


```{r}
#lets selects samples with atleats more than 1000 reads from non-chimeric reads.

ww_data_filtered <- ww_data %>% 
  filter( `non-chimeric`> 10000) %>%
  select('Replicate','sample.id', 'Genotype', 'Day', 'Treatment', 'non-chimeric')

```

```{r}
ww_data_filtered

```

```{r}

#save the filtered data to a file.

write.csv(ww_data_filtered, "ww_data_filtered.csv")

```

```{r}
# inspecting ASVs and Taxonomy files.

#taxonomy file

taxas <- read_tsv("taxonomy.tsv", show_col_types = FALSE)

#ASV file

asv <- read_tsv("frequency_genus-table.tsv", show_col_types = FALSE)

```

```{r}
problems(asv)
problems(taxas)

```

```{r}
head(taxas)
```



#New analysis
```{r}
# create a phyloseq object from the qiime2 artifacts.

ps_object <- qza_to_phyloseq(
  features = "filtered_table.qza",
  tree = "insertion-tree.qza","taxonomy.qza",
  metadata = "MetData_Pathogen_removal.tsv"
)  

```

```{r}

# print the phyloseq object.

ps_object

```

```{r}
# inspect the phyloseq object.

summary(sample_sums(ps_object))
```

```{r}
# rarefy the phyloseq object to the minimum sample read depth.

set.seed(1234)

# plot the read depth before rarefaction.
plot_read_depth <-  function(ps_object){
  # Extract sample read depths
  read_depths <- sample_sums(ps_object)
  
  # create a data frame with sample names and read depths
  df <- data.frame(Sample = names(read_depths), Read_Depth = read_depths)
  
  # create the plot
  ggplot(df, aes(x = Sample , y = Read_Depth)) +
    geom_bar(stat = "identity", fill = "steelblue") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    labs(x = "Sample", y = "Read Depth", title = "Read Depth Before Rarefaction")
}

# plot the read depth before rarefaction
plot_read_depth(ps_object)

```

```{r}
# Rarefy the phyloseq object to the minimum(even) sample read depth.

ps_object_rarefied <- rarefy_even_depth(ps_object, rngseed = 1234,  sample.size = 22574,
                                        replace = TRUE, verbose = TRUE, trimOTUs = TRUE) # trimOTUs = TRUE removes OTUs with zero counts in all samples.

# plot rarefaction curves with custom color.
set.seed(123)
otu_mat <- t(as(otu_table(ps_object_rarefied), "matrix"))
rarecurve(otu_mat, step = 500, col = "red", cex = 0.8, 
          xlab = "Number of Sequences", ylab = "Number of ASVs", 
          main = "Rarefaction Curves")

```

```{r}
# inspect the rarefied phyloseq object.

table(tax_table(ps_object_rarefied)[, "Phylum"], exclude = NULL)

```


```{r}

# if any of the phylum has only one feature, consider removing it
ps_object_rare_subset <- subset_taxa(ps_object_rarefied, !is.na(Phylum) & !Phylum %in% c("Spirochaetota", "Campilobacterota", "Elusimicrobiota", "NA"))

table(tax_table(ps_object_rare_subset)[, "Phylum"], exclude = NULL)

```
```{r}
# remove features with ambiguous phylum annotation.

ps_object_rare_subset <- subset_taxa(ps_object_rare_subset, !is.na(Phylum) & !Phylum %in% c("", "uncharacterized"))

```

```{r}
#compute the prevalence of each feature and store in a data frame
prevdf_rarefied <- apply(X = otu_table(ps_object_rare_subset),      
                   MARGIN = ifelse(taxa_are_rows(ps_object_rare_subset), yes = 1,   no= 2), # number of samples in which taxa are present at least once.
                   FUN = function(OTU) {sum(OTU > 0)})

```

```{r}
# Add taxonomy and total read counts to the data frame.
prevdf_rarefied <- data.frame(Prevalence = prevdf_rarefied,
                        TotalAbundance = taxa_sums(ps_object_rare_subset),
                        tax_table(ps_object_rare_subset))

prevdf_rarefied

```

```{r}
# Are there phyla that are comprised of low prevalence features?
# compute the total and average prevalence of features in each phylum.

plyr::ddply(prevdf_rarefied, "Phylum",
            function(df1){cbind(mean(df1$Prevalence), sum(df1$Prevalence))})

```

```{r}
# remove features with low prevalence.

filterPhyla <-  c("Fibrobacterota", "Firmicutes", "Planctomycetota", "Nitrospirota") # phyla with low prevalence features.

# filter entries with unidentified phylum.
ps_object_rare1 <- subset_taxa(ps_object_rare_subset, Phylum %in% filterPhyla)

ps_object_rare1

```

# Prevalence filtering
```{r}
# subset to the remaining phyla.

prevdf_rare1 <- subset(prevdf_rarefied, Phylum %in% get_taxa_unique(ps_object_rare1, "Phylum"))

```

```{r}
ggplot(prevdf_rare1, aes(TotalAbundance, Prevalence / nsamples(ps_object_rare_subset), color = Phylum)) +
  # include a guess for parameter
  
  geom_hline(yintercept = 0.05, alpha = 0.5, linetype = 2) +
  geom_point(size = 2, alpha = 0.7) +
  scale_x_log10() + xlab("Total Abundance") + ylab("Prevalence [Frac. samples]") +
  facet_wrap(~Phylum) +
  theme(legend.position = "none") 
```

```{r}
# define the prevance threshold. as 5% of total sampls.
set.seed(1234)
prevalence_threshold <- 0.05 * nsamples(ps_object_rare_subset)  ## 5% of total samples.
prevalence_threshold  

```
# Note: prevalence filtering is used to remove 
#rare features that are only present in less than half of the samples
```{r}
# Execute prevalence filtering.

keepTaxa <-  rownames(prevdf_rarefied)[(prevdf_rarefied$Prevalence >= prevalence_threshold)]
ps_object_rare2 <- prune_taxa(keepTaxa,ps_object_rare_subset)
ps_object_rare2

```

```{r}
# phyloseq object before filtering
ps_object_rare_subset

```

# Agglomerate taxa
```{r}
# how many genera would be present after filtering?
length(get_taxa_unique(ps_object_rare2, "Genus"))

```

```{r}
# how many family would be present after filtering?
length(get_taxa_unique(ps_object_rare2, "Family"))

```

```{r}
ps_object_rare3 <- tax_glom(ps_object_rare2, "Genus", NArm = TRUE)
ps_object_rare4 <- tax_glom(ps_object_rare2, "Family", NArm = TRUE)

```


# Calculate apha and beta diveristy at varying prevalence thresholds.
```{r}
# define the prevalence thresholds.
prevthreshold <-  c(0.01,0.05, 0.1, 0.2, 0.5)

```

```{r}
# function to calculate alpha and beta diversity metrics.
calc_diversity <- function(prevdf_rarefied, prevthreshold){
 
   # filter taxa based on prevalence threshold.
  ps_object_filtered <- filter_taxa(ps_object_rare_subset, function(x) sum(x > 0) > (prevthreshold * length(x)), TRUE)
  
                        
  
  # calculate alpha diversity
  alpha_div <- estimate_richness(ps_object_filtered, measures = c("Observed", "Shannon", "Simpson"))
  
  # calculate beta diversity
  beta_div <- vegdist(otu_table(ps_object_filtered), method = "bray")
  
  return(list(alpha_div = alpha_div, beta_div = beta_div))
}

```


```{r}
#evaluate the diversity at different prevalence thresholds.
diversity_list <- lapply(prevthreshold, function(threshold) calc_diversity(prevdf_rarefied, threshold))

```

```{r}
# print alpha diversity result.
lapply(diversity_list, function(x) x$alpha_div)

```

```{r}


lapply(diversity_list, function(x) print(summary(as.dist(x$beta_div))))

```

```{r}

# calculate the alpha diversity metrics.

alpha_div <- estimate_richness(ps_object_rare2, measures = c("Observed", "Shannon", "Simpson"))

# plot alpha divresity metrics.
plot_richness(ps_object_rare2, x = "Day", measures ="Simpson") +
  geom_boxplot(aes(fill = Treatment))+ # Add fill color based on Treatment.
  theme_bw() +
  facet_grid(~Genotype) + # facet by Genotype.
  theme(
    axis.text.x = element_text(angle = 90,
                               hjust = 1,
                               vjust = 0.5),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.text = element_text(size = 12)) +# rotate x-axis labels.
 scale_y_continuous(limits = c(0, max(alpha_div$Simpson) * 1.1), # Adjust y-axis limits
                     expand = c(0, 0))
```

```{r}
# calculate beta diversity.

bc_dist <-  phyloseq::distance(ps_object_rare2, method = "bray")

# ordinate using PCoA

ord <-  ordinate(ps_object_rare2, method = "PCoA", distance = bc_dist)

# Plot PCoA

plot_ordination(ps_object_rare2, ord, color = "Treatment", title = "Bray-Curtis PCoA") +
  geom_point(size = 3) +
  
  theme_bw() 
  




```



```{r}

# Calculate Bray-Curtis dissimilarity
bc_dist <- phyloseq::distance(ps_object_rare2, method = "bray")

# Perform PCoA ordination
ord <- ordinate(ps_object_rare2, method = "PCoA", distance = bc_dist)

# Plot PCoA ordination
plot_ordination(ps_object_rare2, ord, color = "Genotype", shape = "Day") +
  facet_grid(~Treatment) +  # Add facet_grid to create separate plots for each Day
  geom_point(size = 5) +
  theme_bw()



```
```{r}

# Calculate Bray-Curtis dissimilarity
bc_dist <- phyloseq::distance(ps_object_rare2, method = "bray")

# Perform PCoA ordination
ord <- ordinate(ps_object_rare2, method = "PCoA", distance = bc_dist)

# Plot PCoA ordination
plot_ordination(ps_object_rare2, ord, color = "Genotype", shape = "Day") +
  geom_point(aes(fill = Treatment), size = 5, stroke = 1) +
  scale_shape_manual(values = c(21, 22, 23)) +  # Different shapes for each Day
  scale_fill_manual(values = c("white", "black")) +  # Fill colors for Treatment
  theme_bw() +
  labs(title = "PCoA of Bray-Curtis Dissimilarity",
       x = "PCoA1", y = "PCoA2") +
  theme(legend.position = "right",
        plot.title = element_text(hjust = 0.5, size = 16),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 10)) +
  guides(color = guide_legend(title = "Genotype"),
         shape = guide_legend(title = "Day"),
         fill = guide_legend(title = "Treatment"))



```

```{r}
library(phyloseq)
library(ggplot2)
library(dplyr)
library(RColorBrewer)
library(microbiome)

# Aplly transformation to the data

ps_object_rare2_transformed <- transform_sample_counts(ps_object_rare2, function(x) x / sum(x))

# Calculate Bray-Curtis dissimilarity
bc_dist <- phyloseq::distance(ps_object_rare2_transformed, method = "bray")


# Perform PCoA ordination
ord <- ordinate(ps_object_rare2_transformed, method = "PCoA", distance = bc_dist)

# Extract the percent variance explained by each axis
variance_explained <- ord$values$Relative_eig * 100

# Create a data frame with the PCoA coordinates and metadata
plot_data <- data.frame(
  PC1 = ord$vectors[,1],
  PC2 = ord$vectors[,2],
  Day = sample_data(ps_object_rare2_transformed)$Day,
  Genotype = sample_data(ps_object_rare2_transformed)$Genotype
)

# Define color palettes for Genotype and Day
genotype_colors <- brewer.pal(n = length(unique(plot_data$Genotype)), name = "Set1")
day_colors <- brewer.pal(n = length(unique(plot_data$Day)), name = "Dark2")

# Plot PCoA ordination
ggplot(plot_data, aes(x = PC1, y = PC2)) +
  geom_point(aes(color = Genotype, shape = Day), size = 5, stroke = 1.5) +
  scale_color_manual(values = genotype_colors) +
  scale_shape_manual(values = c(16, 17, 18)) +
  labs(
    x = paste0("PC1 (", round(variance_explained[1], 2), "%)"),
    y = paste0("PC2 (", round(variance_explained[2], 2), "%)"),
    title = "PCoA of Bray-Curtis Dissimilarity",
    color = "Genotype",
    shape = "Day"
  ) +
  theme_bw() +
  theme(
    legend.position = "right",
    plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),
    axis.title = element_text(size = 16, face = "bold"),
    axis.text = element_text(size = 14),
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 12),
    legend.key.size = unit(1, "cm")
  ) +
  guides(color = guide_legend(override.aes = list(size = 5)),
         shape = guide_legend(override.aes = list(size = 5)))

ggsave("PCoA_Genotype_Day.pdf", width = 10, height = 8, dpi = 300)

```





```{r}
library(phyloseq)
library(ggplot2)
library(pheatmap)

# Calculate Bray-Curtis dissimilarity
bc_dist <- phyloseq::distance(ps_object_rare2, method = "bray")

# Convert distance matrix to a data frame
bc_dist_df <- as.data.frame(as.matrix(bc_dist))

# Get metadata
metadata <- data.frame(sample_data(ps_object_rare2))

# Create annotation dataframe. This dataframe will be used to color the heatmap based on metadata.
annotation_df <- data.frame(
  Genotype = metadata$Genotype,
  Treatment = metadata$Treatment,
  Day = metadata$Day
)

# Define colors for annotation
annotation_colors <- list(
  Genotype = c("LRV_0_1" = "red", "LRV_12_3" = "blue", "LRV_8.5_3" = "green", "LR2_36_1" = "purple"), #
  Treatment = c("Wastewater_Control" = "orange", "Wastewater_Daphnia" = "cyan"),
  Day = c("D1" = "yellow", "D2" = "pink", "D3" = "brown")
)

# Create heatmap
pheatmap(bc_dist_df,
         annotation_col = annotation_df,
         annotation_colors = annotation_colors,
         show_rownames = FALSE,
         show_colnames = FALSE,
         main = "Bray-Curtis Distance Heatmap",
         clustering_distance_rows = bc_dist,
         clustering_distance_cols = bc_dist,
         width = 15,
         height = 12,
         angle_col = 45
         )

```
```{r}
print(unique(annotation_df$Genotype))
print(unique(annotation_df$Treatment))
print(unique(annotation_df$Day))


```
```{r}
library(phyloseq)
library(pheatmap)
library(gridExtra)

# Calculate Bray-Curtis dissimilarity
bc_dist <- phyloseq::distance(ps_object_rare2, method = "bray")

# Convert distance matrix to a data frame
bc_dist_df <- as.data.frame(as.matrix(bc_dist))

# Ensure row names and column names match
if(!all(rownames(bc_dist_df) == colnames(bc_dist_df))) {
  warning("Row names and column names of bc_dist_df don't match. This may cause issues.")
}

# Get metadata
metadata <- data.frame(sample_data(ps_object_rare2))

# Create annotation dataframe
annotation_df <- data.frame(
  Genotype = metadata$Genotype,
  Treatment = metadata$Treatment,
  Day = metadata$Day
)

# Ensure sample names in annotation_df match bc_dist_df
rownames(annotation_df) <- rownames(metadata)
if(!all(rownames(annotation_df) %in% colnames(bc_dist_df))) {
  warning("Some sample names in annotation_df are not present in bc_dist_df. This may cause issues.")
}

# Define colors for annotation
annotation_colors <- list(
  Treatment = c("Wastewater_Control" = "orange", "Wastewater_Daphnia" = "cyan"),
  Day = c("D1" = "yellow", "D2" = "pink", "D3" = "brown")
)

# Create a list to store heatmaps
heatmap_list <- list()

# Loop through each genotype
for (genotype in unique(annotation_df$Genotype)) {
  # Subset data for the current genotype
  genotype_samples <- rownames(annotation_df)[annotation_df$Genotype == genotype]
  
  # Ensure genotype_samples exist in bc_dist_df
  valid_samples <- intersect(genotype_samples, colnames(bc_dist_df))
  
  if(length(valid_samples) == 0) {
    warning(paste("No valid samples found for genotype:", genotype))
    next
  }
  
  bc_dist_subset <- bc_dist_df[valid_samples, valid_samples]
  annotation_subset <- annotation_df[valid_samples, c("Treatment", "Day")]
  
  # Check if subset is empty
  if(nrow(bc_dist_subset) == 0 || ncol(bc_dist_subset) == 0) {
    warning(paste("Empty subset for genotype:", genotype))
    next
  }
  
  # Create heatmap for the current genotype
  tryCatch({
    heatmap <- pheatmap(bc_dist_subset,
                        annotation_col = annotation_subset,
                        annotation_colors = annotation_colors,
                        show_rownames = FALSE,
                        show_colnames = FALSE,
                        main = paste("Bray-Curtis Distance Heatmap -", genotype),
                        clustering_distance_rows = as.dist(bc_dist_subset),
                        clustering_distance_cols = as.dist(bc_dist_subset),
                        silent = TRUE)
    
    # Store the heatmap in the list
    heatmap_list[[genotype]] <- heatmap$gtable
  }, error = function(e) {
    warning(paste("Error creating heatmap for genotype:", genotype, "\nError message:", e$message))
  })
}

# Check if any heatmaps were created
if(length(heatmap_list) == 0) {
  stop("No heatmaps were created. Please check your data and error messages.")
}

# Arrange all heatmaps in a grid
grid.arrange(grobs = heatmap_list, ncol = 2)


```


```{r}

print(colnames(bc_dist_df))
print(genotype_samples)


```

```{r}
library(phyloseq)
library(pheatmap)
library(gridExtra)
library(dplyr)

# Calculate Bray-Curtis dissimilarity
bc_dist <- phyloseq::distance(ps_object_rare2, method = "bray")

# Convert distance matrix to a data frame
bc_dist_df <- as.data.frame(as.matrix(bc_dist))

# Ensure row names and column names match
if(!all(rownames(bc_dist_df) == colnames(bc_dist_df))) {
  warning("Row names and column names of bc_dist_df don't match. This may cause issues.")
}

# Get metadata
metadata <- data.frame(sample_data(ps_object_rare2))

# Create annotation dataframe
annotation_df <- data.frame(
  Genotype = metadata$Genotype,
  Treatment = metadata$Treatment,
  Day = metadata$Day
)

# Ensure sample names in annotation_df match bc_dist_df
rownames(annotation_df) <- rownames(metadata)
if(!all(rownames(annotation_df) %in% colnames(bc_dist_df))) {
  warning("Some sample names in annotation_df are not present in bc_dist_df. This may cause issues.")
}

# Check data distribution
print("Distribution of samples across Genotype and Treatment:")
print(table(annotation_df$Genotype, annotation_df$Treatment))

# Define colors for annotation with increased contrast
annotation_colors <- list(
  Treatment = c("Wastewater_Control" = "red", "Wastewater_Daphnia" = "blue"),
  Day = c("D1" = "yellow", "D2" = "pink", "D3" = "brown")
)

# Create a list to store heatmaps
heatmap_list <- list()

# Loop through each genotype
for (genotype in unique(annotation_df$Genotype)) {
  # Subset data for the current genotype
  genotype_samples <- rownames(annotation_df)[annotation_df$Genotype == genotype]
  
  # Ensure genotype_samples exist in bc_dist_df
  valid_samples <- intersect(genotype_samples, colnames(bc_dist_df))
  
  if(length(valid_samples) == 0) {
    warning(paste("No valid samples found for genotype:", genotype))
    next
  }
  
  bc_dist_subset <- bc_dist_df[valid_samples, valid_samples]
  annotation_subset <- annotation_df[valid_samples, c("Treatment", "Day")]
  
  # Check if subset is empty
  if(nrow(bc_dist_subset) == 0 || ncol(bc_dist_subset) == 0) {
    warning(paste("Empty subset for genotype:", genotype))
    next
  }
  
  # Print unique treatments for this genotype
  print(paste("Unique treatments for genotype", genotype, ":"))
  print(unique(annotation_subset$Treatment))
  
  # Create heatmap for the current genotype
  tryCatch({
    heatmap <- pheatmap(bc_dist_subset,
                        annotation_col = annotation_subset,
                        annotation_colors = annotation_colors,
                        show_rownames = FALSE,
                        show_colnames = FALSE,
                        main = paste("Bray-Curtis Distance Heatmap -", genotype),
                        clustering_distance_rows = as.dist(bc_dist_subset),
                        clustering_distance_cols = as.dist(bc_dist_subset),
                        annotation_legend = TRUE,
                        annotation_names_col = FALSE,
                        annotation_names_row = FALSE,
                        silent = TRUE)
    
    # Store the heatmap in the list
    heatmap_list[[genotype]] <- heatmap$gtable
  }, error = function(e) {
    warning(paste("Error creating heatmap for genotype:", genotype, "\nError message:", e$message))
  })
}

# Check if any heatmaps were created
if(length(heatmap_list) == 0) {
  stop("No heatmaps were created. Please check your data and error messages.")
}

# Arrange all heatmaps in a grid
grid.arrange(grobs = heatmap_list, ncol = 2)



```


```{r}
# Extract phylum information
tax_table <- tax_table(ps_object_rare2)
phylum_data <- tax_table[, "Phylum"]
otu_table <- otu_table(ps_object_rare2)

# Aggregate OTU counts at phylum level
phylum_counts <- aggregate(otu_table, by = list(Phylum = phylum_data), sum)
rownames(phylum_counts) <- phylum_counts$Phylum
phylum_counts$Phylum <- NULL

# Convert to relative abundance
phylum_rel_abund <- sweep(phylum_counts, 2, colSums(phylum_counts), '/')



```



```{r}
# Loop through each genotype
for (genotype in unique(annotation_df$Genotype)) {
  # Subset data for the current genotype
  genotype_samples <- rownames(annotation_df)[annotation_df$Genotype == genotype]
  
  # Ensure genotype_samples exist in bc_dist_df
  valid_samples <- intersect(genotype_samples, colnames(bc_dist_df))
  
  if(length(valid_samples) == 0) {
    warning(paste("No valid samples found for genotype:", genotype))
    next
  }
  
  bc_dist_subset <- bc_dist_df[valid_samples, valid_samples]
  annotation_subset <- annotation_df[valid_samples, c("Treatment", "Day")]
  phylum_subset <- phylum_rel_abund[, valid_samples]
  
  # Check if subset is empty
  if(nrow(bc_dist_subset) == 0 || ncol(bc_dist_subset) == 0) {
    warning(paste("Empty subset for genotype:", genotype))
    next
  }
  
  # Create heatmap for the current genotype
  tryCatch({
    # Bray-Curtis distance heatmap
    heatmap_bc <- pheatmap(bc_dist_subset,
                           annotation_col = annotation_subset,
                           annotation_colors = annotation_colors,
                           show_rownames = FALSE,
                           show_colnames = FALSE,
                           main = paste("Bray-Curtis Distance -", genotype),
                           clustering_distance_rows = as.dist(bc_dist_subset),
                           clustering_distance_cols = as.dist(bc_dist_subset),
                           annotation_legend = TRUE,
                           annotation_names_col = FALSE,
                           annotation_names_row = FALSE,
                           silent = TRUE)
    
    # Phylum relative abundance heatmap
    heatmap_phylum <- pheatmap(phylum_subset,
                               annotation_col = annotation_subset,
                               annotation_colors = annotation_colors,
                               show_rownames = TRUE,
                               show_colnames = FALSE,
                               main = paste("Phylum Relative Abundance -", genotype),
                               clustering_distance_cols = as.dist(bc_dist_subset),
                               annotation_legend = TRUE,
                               annotation_names_col = FALSE,
                               annotation_names_row = FALSE,
                               silent = TRUE)
    
    # Combine the two heatmaps
    combined_heatmap <- grid.arrange(heatmap_bc$gtable, heatmap_phylum$gtable, ncol = 1)
    
    # Store the combined heatmap in the list
    heatmap_list[[genotype]] <- combined_heatmap
  }, error = function(e) {
    warning(paste("Error creating heatmap for genotype:", genotype, "\nError message:", e$message))
  })
}




```



```{r}
library(ggplot2)

ggplot(annotation_df, aes(x = 1, y = 1, fill = Genotype)) +
  geom_tile() +
  scale_fill_manual(values = annotation_colors$Genotype)

ggplot(annotation_df, aes(x = 1, y = 1, fill = Treatment)) +
  geom_tile() +
  scale_fill_manual(values = annotation_colors$Treatment)

ggplot(annotation_df, aes(x = 1, y = 1, fill = Day)) +
  geom_tile() +
  scale_fill_manual(values = annotation_colors$Day)



```



```{r}


plot_ordination(ps_object_rare2, ord, color = "Genotype", title = "Bray-Curtis PCoA") +
  geom_point(size = 3) +
  stat_ellipse(aes(group = Genotype), level = 0.95, linetype = 2) +
  scale_x_continuous(breaks = seq(-1,1,0.2)) +
  theme_bw()
```


```{r}
plot_ordination(ps_object_rare2, ord, color = "Genotype", title = "Bray-Curtis PCoA") +
  geom_point(size = 3) +
  stat_ellipse(level = 0.95, linetype = 2) +
  coord_equal() +
  theme_bw()

```
```{r}

plot_ordination(ps_object_rare2, ord, color = "Day", title = "Bray-Curtis PCoA") +
  geom_point(size = 3) +
  stat_ellipse(aes(group = Day), level = 0.95, linetype = 2) +
  scale_x_continuous(breaks = seq(-1,1,0.2)) +
  theme_bw()

```
```{r}
 #Permutation test for differences between treatments

bc_adonis <- adonis(bc_dist ~ get_variable(ps_object_rare2, "Genotype"))
bc_adonis

```

```{r}
# Calculate weighted UniFrac distances
unifrac_dist <- UniFrac(ps_object_rare2, weighted = TRUE)

# Perform PCoA ordination
ord_unifrac <- ordinate(ps_object_rare2, "PCoA", distance = unifrac_dist)

# Plot PCoA with weighted UniFrac
plot_ordination(ps_object_rare2, ord_unifrac, color = "Genotype", title = "Weighted UniFrac PCoA") +
  geom_point(size = 3) +
  stat_ellipse(aes(group = Genotype), level = 0.95, linetype = 2) +
  scale_x_continuous(breaks = seq(-1, 1, 0.2)) +
  theme_bw()

```


```{r}
merge_less_than_top_ps <- function(ps_object_rare2, top = 20) { transformed <- transform_sample_counts(ps_object_rare2, function(OTU) OTU/sum(OTU)) 
otu.table <- as.data.frame(otu_table(transformed))
otu.sort <- otu.table[order(rowMeans(otu.table), decreasing = TRUE),]
otu.list <- row.names(otu.sort[(top + 1):nrow(otu.sort),])
merged <- merge_taxa(transformed, otu.list, 1)
for (i in 1:dim(tax_table(merged))[1]){
  if (is.na(tax_table(merged)[i,2])){
    taxa_names(merged)[i] <- "Other"
    tax_table(merged)[i, 1:6] <- "other"
  }
}
return(merged) 
}

```


```{r}
ps_gen <- tax_glom(ps_object_rare2, "Genus", NArm = TRUE)
ps_family <- tax_glom(ps_object_rare2, "Family", NArm = TRUE)


```

```{r}
# Merge less than top 15 genera and families
ps_Gen_15 <- merge_less_than_top_ps(ps_gen, top = 20)
pf_family_15 <- merge_less_than_top_ps(ps_family, top = 20)

```

```{r}
# convert to dataframe
df_gen_top15 <- psmelt(ps_Gen_15) %>%
  filter(Abundance > 0) %>%
  arrange(Genus)
df_family_top15 <- psmelt(pf_family_15) %>%
  filter(Abundance > 0) %>%
  arrange(Family)

```

```{r}
#save the data
write.csv(df_gen_top15, "genus_top15.csv")
write.csv(df_family_top15, "family_top15.csv")

```

```{r}

df_gen_top15 
```

```{r}

df_family_top15

```

```{r}
library(ggplot2)
library(dplyr)
library(tidyr)

# Assuming tax_rel_abun_pf_gen_top10 is your data frame
# First, let's ensure we have the top 15 genera
top_15_genera <- df_gen_top15 %>%
  group_by(Genus) %>%
  summarize(total_abundance = sum(Abundance)) %>%
  top_n(15, total_abundance) %>%
  pull(Genus)

# Filter the data for top 15 genera
data_top_15 <- df_gen_top15 %>%
  filter(Genus %in% top_15_genera)

# Create the plot
WW <- ggplot(
  data_top_15, 
  aes(x = Day, y = Abundance, fill = Genus)
) +
  facet_grid(Genotype ~ Treatment, scales = "free_x") +
  geom_bar(stat = "identity", position = "fill") +
  labs(x = "Day", y = "Relative Abundance", title = "Top 15 Genera Relative Abundance") +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_fill_brewer(palette = "Paired") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 8, angle = 90, vjust = 0.5, hjust = 1),
    axis.text.y = element_text(size = 8),
    legend.text = element_text(size = 7),
    legend.title = element_text(size = 8),
    strip.text = element_text(size = 8),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "bottom"
  ) +
  guides(fill = guide_legend(ncol = 5))

print(WW)


```



```{r}

library(ggplot2)
library(dplyr)
library(tidyr)

# Function to create the plot for a specific genotype vs control
plot_genotype_vs_control <- function(data, genotype_of_interest, control_genotype = "CONTROL") {
  # Filter data for the genotype of interest and control
  filtered_data <- data %>%
    filter(Genotype %in% c(genotype_of_interest, control_genotype))
  
  # Get top 15 genera
  top_15_genera <- filtered_data %>%
    group_by(Genus) %>%
    summarize(total_abundance = sum(Abundance)) %>%
    top_n(15, total_abundance) %>%
    pull(Genus)
  
  # Filter for top 15 genera
  data_top_15 <- filtered_data %>%
    filter(Genus %in% top_15_genera)
  
  # Create the plot
  plot <- ggplot(
    data_top_15, 
    aes(x = Day, y = Abundance, fill = Genus)
  ) +
    facet_grid(Genotype ~ Treatment, scales = "free_x") +
    geom_bar(stat = "identity", position = "fill") +
    labs(
      x = "Day", 
      y = "Relative Abundance", 
      title = paste("Top 15 Genera Relative Abundance:", genotype_of_interest, "vs", control_genotype)
    ) +
    scale_y_continuous(labels = scales::percent_format()) +
    scale_fill_brewer(palette = "Paired") +
    theme_minimal() +
    theme(
      axis.text.x = element_text(size = 8, angle = 90, vjust = 0.5, hjust = 1),
      axis.text.y = element_text(size = 8),
      legend.text = element_text(size = 7),
      legend.title = element_text(size = 8),
      strip.text = element_text(size = 8),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.position = "bottom"
    ) +
    guides(fill = guide_legend(ncol = 5))
  
  return(plot)
}

# Usage example:
# Replace 'df_gen_top15' with your actual data frame name
# Replace 'LRV_0_1' with the genotype you want to compare against control
WW <- plot_genotype_vs_control(df_gen_top15, "LRV_0_1")
print(WW)

# To plot a different genotype, just change the genotype name:
# WW <- plot_genotype_vs_control(df_gen_top15, "LRV_12_3")
# print(WW)


```


```{r}
gen_10<- ggplot(
  df_gen_top15, aes(x = Day, y = Abundance, fill = Genus)
)+
  facet_grid(~Genotype, scales = "free")+
  geom_bar(stat = "identity", position = "fill")+
  labs(x="Day", y="Rel. Abun", title = "Genus relative abundance") +
   theme(
    axis.text.x = element_text(size = 10, 
    angle = 90, vjust = 0.5, hjust = 1),
    axis.text.y = element_text(size = 8),
    legend.text = element_text(size = 8),
    strip.text = element_text(size = 8)
  )
gen_10
```
```{r}
library(ggplot2)
library(viridis)  # For a more vibrant color palette

gen_10 <- ggplot(
  df_gen_top15, aes(x = Day, y = Abundance, fill = Genus)
) +
  facet_grid(~Genotype, scales = "free") +
  geom_bar(stat = "identity", position = "fill") +
  labs(x = "Day", y = "Relative Abundance", title = "Genus Relative Abundance") +
  scale_fill_viridis(discrete = TRUE, option = "turbo") +  # More vibrant color palette
  theme_minimal() +  # Cleaner background
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    axis.title = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(size = 12, angle = 90, vjust = 0.5, hjust = 1),
    axis.text.y = element_text(size = 12),
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 10),
    strip.text = element_text(size = 14, face = "bold"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "bottom"
  ) +
  guides(fill = guide_legend(ncol = 3))  # Adjust legend layout

# Increase plot size
ggsave("genus_relative_abundance.png", gen_10, width = 15, height = 10, dpi = 300)

# Display the plot
print(gen_10)


```

```{r}
family_15 <- ggplot(
  df_family_top15, aes(x = Day, y = Abundance, fill = Family)
) +
  facet_grid(~Genotype, scales = "free") +
  geom_bar(stat = "identity", position = "fill") +
  labs(x = "Day", y = "Relative Abundance", title = "Family Relative Abundance") +
  scale_fill_viridis(discrete = TRUE, option = "turbo") +  # More vibrant color palette
  theme_minimal() +  # Cleaner background
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    axis.title = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(size = 12, angle = 90, vjust = 0.5, hjust = 1),
    axis.text.y = element_text(size = 12),
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 10),
    strip.text = element_text(size = 14, face = "bold"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "bottom"
  ) +
  guides(fill = guide_legend(ncol = 3))  # Adjust legend layout

# Increase plot size
ggsave("Family_relative_abundance.png", gen_10, width = 15, height = 10, dpi = 300)

# Display the plot
print(family_15)

```

```{r}
#PERMANOVA on Bray-Curtis dissimilarity matrix.





