---
title: "Wastewater bacterial removal analysis"
output: rmarkdown::github_documemt
author: "Muhammad"
---



```{r}
# load libraries
library(tidyverse)
library(qiime2R)
library(microbiome)
library(DT)
library(data.table)
library(ggpubr)
library(vegan)
library(DESeq2)
library(phyloseq)
```

```{r}

# convert qiime2 artifact to phyloseq object
ps_ww <- qza_to_phyloseq(
  features = "filtered_table.qza",
  tree = "insertion-tree.qza","taxonomy.qza",
  metadata = "Metadata.tsv"
)

```


```{r}
ps_ww

```

```{r}
# inspect the phyloseq object
summary(sample_sums(ps_ww))
```

```{r}
set.seed(123)
# rarefy the data to min. reads per sample

ps_ww_rare <- rarefy_even_depth(ps_ww, rngseed = 123, sample.size = 30007, replace = TRUE, trimOTUs = TRUE, verbose = TRUE)
```

```{r}
# inspect the rarefied data
summary(sample_sums(ps_ww_rare))
```

```{r}
table(tax_table(ps_ww_rare)[, "Phylum"], exclude = NULL)
```

```{r}
# if any of the phylum has only one feature, consider removing it
ww_rare <- subset_taxa(ps_ww_rare, !is.na(Phylum) & !Phylum %in% c("Nitrospirota", "Fibrobacterota", "Planctomycetota", "NA"))

ww_rare 
```

```{r}
#compute the prevalence of each feature and store in a data frame
prevdf_ww <- apply(X = otu_table(ww_rare),
                   MARGIN = ifelse(taxa_are_rows(ww_rare), yes = 1,   no= 2),
                   FUN = function(OTU) {sum(OTU > 0)})
```

```{r}
# Add taxonomy and total read counts to the data frame.
prevdf_ww <- data.frame(Prevalence = prevdf_ww,
                        TotalAbundance = taxa_sums(ww_rare),
                        tax_table(ww_rare))

prevdf_ww
```

```{r}
# investigate low prevalence/abundance features and subset them out
plyr::ddply(prevdf_ww, "Phylum", function(df1) {
  data.frame(mean_prevalence = mean(df1$Prevalence), total_abundance = sum(df1$ TotalAbundance, na.rm = T), stringsAsFactors = F)
})
```

```{r}
# Define prevalence and abundance thresholds
set.seed(123)
prevalence_threshold <- 0.50 * nsamples(ww_rare)

prevalence_threshold
```

```{r}
# execute the prevalence filter
keep_taxa <- rownames(prevdf_ww)[prevdf_ww$Prevalence >= prevalence_threshold]

length(keep_taxa)
```

```{r}
ww_rare.2 = prune_taxa(keep_taxa, ww_rare)
ww_rare.2
```

```{r}
merge_less_than_top_ww <- function(ww_rare.2, top = 10) { transformed <- transform_sample_counts(ww_rare.2, function(OTU) OTU/sum(OTU)) 
otu.table <- as.data.frame(otu_table(transformed))
otu.sort <- otu.table[order(rowMeans(otu.table), decreasing = TRUE),]
otu.list <- row.names(otu.sort[(top + 1):nrow(otu.sort),])
merged <- merge_taxa(transformed, otu.list, 1)
for (i in 1:dim(tax_table(merged))[1]){
  if (is.na(tax_table(merged)[i,2])){
    taxa_names(merged)[i] <- "Other"
    tax_table(merged)[i, 1:6] <- "other"
  }
}
return(merged) 
}
```

```{r}
ww_Gen <- tax_glom(ww_rare.2, taxrank = "Genus")
ww_Gen
```

```{r}
ww_Gen_10 <- merge_less_than_top_ww(ww_Gen, top = 10)
ww_Gen_10
```

```{r}
# convert to dataframe
tax_rel_abun_pf_gen_top10 <- psmelt(ww_Gen_10) %>%
  filter(Abundance > 0) %>%
  arrange(Genus)

tax_rel_abun_pf_gen_top10
```
```{r}
write.csv(tax_rel_abun_pf_gen_top10, "tax_rel_abun_pf_gen_top10.csv")
```


```{r}
WW<- ggplot(
  tax_rel_abun_pf_gen_top10, aes(x = Day, y = Abundance, fill = Genus)
)+
  facet_grid(~Treatment, scales = "free")+
  geom_bar(stat = "identity", position = "fill")+
  labs(x="Day", y="Rel. Abun", title = "Genus relative abundance") +
   theme(
    axis.text.x = element_text(size = 10, 
    angle = 90, vjust = 0.5, hjust = 1),
    axis.text.y = element_text(size = 8),
    legend.text = element_text(size = 8),
    strip.text = element_text(size = 8)
  )
```

```{r}
WW
```
```{r}
# Filter the data for Day 3 only
day3_data <- tax_rel_abun_pf_gen_top10 %>%
  filter(Day == 'D3')

# Find the top ten genera based on their mean abundance on Day 3
top_genera <- day3_data %>%
  group_by(Genus) %>%
  summarise(mean_abundance = mean(Abundance)) %>%
  top_n(10, mean_abundance) %>%
  pull(Genus)

# Filter the Day 3 data to include only the top ten genera
day3_top_genera_data <- day3_data %>%
  filter(Genus %in% top_genera)

# Create the bar plot for Day 3 with the top ten genera
WW <- ggplot(day3_top_genera_data, aes(x = Genus, y = Abundance, fill = Genus)) +
  facet_grid(~Treatment, scales = "free_y") +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Genus", y = "Relative Abundance", title = "Top Ten Genera Relative Abundance on Day 3") +
  theme(
    axis.text.x = element_text(size = 10, angle = 90, vjust = 0.5, hjust = 1),
    axis.text.y = element_text(size = 8),
    legend.text = element_text(size = 8),
    strip.text = element_text(size = 8)
  ) #+
  #scale_y_continuous(limits = c(0, 600))  # Set y-axis limits

# Print the bar plot
WW

```

```{r}

# Create the bar plot for Day 3 with the top ten genera
WW <- ggplot(day3_top_genera_data, aes(x = Genus, y = Abundance, fill = Genus)) +
  facet_grid(~Treatment, scales = "free_y") +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Genus", y = "Relative Abundance", title = "Top Ten Genera Relative Abundance on Day 3") +
  theme(
    axis.text.x = element_text(size = 10, angle = 90, vjust = 0.5, hjust = 1),
    axis.text.y = element_text(size = 8),
    legend.text = element_text(size = 8),
    strip.text = element_text(size = 8)
  ) +
  coord_cartesian(ylim = c(0, 1.0))  # Adjust visible y-axis range to 0 to 1.0 without clipping data

# Print the bar plot
WW
```
```{r}
library(dplyr)
library(ggplot2)
library(forcats)

# Assuming 'tax_rel_abun_pf_gen_top10' is your data frame and it contains 'Day', 'Treatment', 'Genus', and 'Abundance' columns

# Filter the data for Day 3 only
day3_data <- tax_rel_abun_pf_gen_top10 %>%
  filter(Day == 'D3')

# Reorder the 'Genus' factor levels based on the sum of 'Abundance', with "other" first
day3_data <- day3_data %>%
  mutate(Genus = fct_reorder(Genus, Abundance, .fun = sum, .desc = TRUE)) %>%
  mutate(Genus = fct_relevel(Genus, "other", after = Inf))  # Place "other" last

# Create the bar plot for Day 3 with the reordered genera
WW <- ggplot(day3_data, aes(x = Genus, y = Abundance, fill = Genus)) +
  facet_grid(~Treatment, scales = "free_y") +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Genus", y = "Relative Abundance", title = "Top Ten Genera Relative Abundance on Day 3") +
  theme(
    axis.text.x = element_text(size = 10, angle = 90, vjust = 0.5, hjust = 1),
    axis.text.y = element_text(size = 8),
    legend.text = element_text(size = 8),
    strip.text = element_text(size = 8)
  ) +
  coord_cartesian(ylim = c(0, 1.0))  # Adjust visible y-axis range to 0 to 1.0 without clipping data

# Print the bar plot
WW


```
```{r}

library(dplyr)
library(ggplot2)
library(forcats)

# Assuming 'tax_rel_abun_pf_gen_top10' is your data frame and it contains 'Day', 'Treatment', 'Genus', and 'Abundance' columns

# Filter the data for Day 3 only
day3_data <- tax_rel_abun_pf_gen_top10 %>%
  filter(Day == 'D3')

# Reorder the 'Genus' factor levels based on the sum of 'Abundance', with "other" first
day3_data <- day3_data %>%
  mutate(Genus = fct_reorder(Genus, Abundance, .fun = sum, .desc = TRUE)) %>%
  mutate(Genus = fct_relevel(Genus, "other", after = Inf))  # Place "other" last

# Create a stacked percentage bar plot for Day 3
WW <- ggplot(day3_data, aes(x = Treatment, y = Abundance, fill = Genus)) +
  geom_bar(stat = "identity", position = "fill") +  # Use position="fill" to scale each bar to sum to 1 (100%)
  labs(x = "Treatment", y = "Relative Abundance (%)", title = "Taxonomic Composition on Day 3") +
  scale_y_continuous(labels = scales::percent) +  # Convert y-axis to percentage
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 12, angle = 0, vjust = 0.5, hjust = 0.5),  # Increase x-axis text size
    axis.text.y = element_text(size = 12),  # Increase y-axis text size
    legend.text = element_text(size = 10),  # Increase legend text size
    strip.text = element_text(size = 12)  # Increase facet label text size
  )

# Print the bar plot
WW

```



```{r}
tax_rel_abun_pf_gen_top10 %>%
  mutate(Genus_pf = case_when(is.na(Genus) ~ "Other", TRUE ~ as.character(Genus))) %>% #this part changes everything that's uncharacterised to be called other
  #filter(Abundance > 0.01) %>% # filter out anything less than 2% abundance
  ggplot(aes(Day,
             Genus_pf, color =
               Genus_pf)) +
  geom_point(aes(size = 
                   Abundance, 
                 fill = Genus_pf)) + #when size = Abundance, it changes the size to depend on the relative abundance in the dataframe.
facet_grid(~Treatment) +
  labs(x="Day", y="Rel. Abun", title = "Genus relative abundance") +
   theme(
    axis.text.x = element_text(size = 10, 
    angle = 90, vjust = 0.5, hjust = 1),
    axis.text.y = element_text(size = 8),
    legend.text = element_text(size = 8),
    strip.text = element_text(size = 8)
  )

```

```{r}
#class taxa
ww_Class <- tax_glom(ww_rare.2, taxrank = "Class")
ww_Class

```

```{r}
library(MicrobiotaProcess)
library(UpSetR)
library(VennDiagram)
```

```{r}
upsetda <- get_upset(obj = ww_rare.2, factorNames= "Treatment")
upsetda
```

```{r}
U_ww <- upset(upsetda, sets=unique(as.vector(sample_data(ww_rare.2)$Treatment)), 
      sets.bar.color = "#56B4E9",
      order.by = "freq", 
      empty.intersections = "on")
U_ww

```

```{r}
vennlist <- get_vennlist(obj = ww_rare.2, factorNames = "Treatment")
```

```{r}
vennp <- venn.diagram(vennlist,
                      height = 5,
                      width = 5,
                      filename = NULL,
                      fill = c("#00AED7", "#FD9347"),
                      cat.col = c("#00AED7", "#FD9347"),
                      alpha = c(0.5, 0.5),
                      fontfamily = "serif",
                      fontface = "bold",
                      cex = 1,
                      cat.default.pos = "outer",
                      cat.dist = 0.1,
                      margin = 0.1,
                      lwd = 3,
                      lty = "dotted",
                      imagetype = "png")
grid.draw(vennp)

```

```{r}

library(grDevices)
pdf(file = "venn.pdf")
grid.draw(vennp)
dev.off()
```

```{r}
        
  #Calculate the mean and standard error
summary_data <- tax_rel_abun_pf_gen_top10 %>%
  group_by(Day, Treatment, Genus) %>%
  summarise(mean = mean(Abundance),
            sd = sd(Abundance),
            se = sd(Abundance)/sqrt(n()))
```

```{r}

pd <- position_dodge(width = 0.5)


```


```{r}
#create the line plot with standard error
ggplot(summary_data, aes(x = Day, y = mean, colour = Treatment, group = Treatment)) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), width = 0.1, position = pd) +
  geom_point(position = pd) +
  facet_wrap(~Genus, scales = "free") +
  labs(x="Day", y="Rel. Abun", title = "Genus relative abundance") +
   theme(
    axis.text.x = element_text(size = 10, 
    angle = 90, vjust = 0.5, hjust = 1),
    axis.text.y = element_text(size = 8),
    legend.text = element_text(size = 8),
    strip.text = element_text(size = 8)
  )
```
```{r}
glom<- tax_glom(ww_rare.2, taxrank = "Genus")
perct <- psmelt(glom)
perct
```

```{r}
# create the data for control and treatment
control_data <- subset(perct, Treatment == "Wastewater_Control")
treatment_data <- subset(perct, Treatment == "Wastewater_Treatment")
```

```{r}

control_ASV_abundance <- perct$Abundance[perct$Treatment == "Wastewater_Control"]
treatment_ASV_abundance <- perct$Abundance[perct$Treatment == "Wastewater_Daphnia"]
```

```{r}
merged_data <- rbind(control_ASV_abundance, treatment_ASV_abundance)
```

```{r}
asv_data_se <- perct %>%
  group_by(Day, Treatment ) %>%
  summarise(mean = mean(Abundance),                               
            sd = sd(Abundance),
            se = sd(Abundance)/sqrt(n()))
```
```{r}

asv_data_se
```



```{r}
# create the line plot with standard error
ggplot(data = asv_data_se, aes(x = Day, y = mean , group = Treatment, color = Treatment)) +  
 #geom_line(position = pd)+
  #geom_point(position = pd)+ 
 geom_bar(stat = "identity", position = pd, color = 'black', fill = "grey") +
 geom_errorbar(data = asv_data_se, aes(ymin = mean - se, ymax = mean + se), position = pd, width = 0.1) +  # Add error bars
  labs(x = "Day", y = "ASV Counts") +  # Add axis labels
  #scale_color_manual(values = c("blue", "red")) +
 # scale_fill_manual(values = c("Wastewater_Control"= "skyblue", "Wastewater_Daphnia" = "salmon")) +
 # geom_text(aes(label = paste0(format(round(mean, 4), nsmall = 1), "%"), y= mean), position = pd, vjust = -0.5) +
  theme_minimal()# Customize line colors
```




```{r}
# Filter the data for Day 3 only
day3_data <- asv_data_se[asv_data_se$Day == 'D3', ]

# Calculate the percentage difference in means
wastewater_daphnia_mean <- day3_data$mean[day3_data$Treatment == "Wastewater_Daphnia"]
wastewater_control_mean <- day3_data$mean[day3_data$Treatment == "Wastewater_control"]
percent_diff <- (wastewater_control_mean - wastewater_daphnia_mean) / wastewater_control_mean * 100

# Create the plot for Day 3
ggplot(data = day3_data, aes(x = Treatment, y = mean, fill = Treatment)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.5) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), position = position_dodge(width = 0.9), width = 0.2) +
  labs(x = "Treatment", y = "ASV Counts", title = paste0("Day 3: ", round(percent_diff, 2), "% Difference")) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_minimal()

```


```{r}

# Calculate the percentage difference in means
wastewater_daphnia_mean <- day3_data$mean[day3_data$Treatment == "Wastewater_Daphnia"]
wastewater_control_mean <- day3_data$mean[day3_data$Treatment == "Wastewater_control"]
percent_diff <- (wastewater_control_mean - wastewater_daphnia_mean) / wastewater_control_mean * 100

# Create the plot for Day 3
ggplot(data = day3_data, aes(x = Treatment, y = mean, fill = Treatment)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.5) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), position = position_dodge(width = 0.9), width = 0.2) +
  labs(x = "Treatment", y = "ASV Counts" ) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_minimal()

```




```{r}

# Create the plot for Day 3 with specified y-axis limits
ggplot(data = day3_data, aes(x = Treatment, y = mean, color = Treatment, group = 1)) +
  geom_line() +  # Add lines
  geom_point(size = 4) +  # Add points to show individual data points
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), width = 0.2) +  # Add error bars
  labs(x = "Treatment", y = "ASV Counts", title = paste0("Day 3: ", round(percent_diff, 2), "% Difference")) +
  theme_minimal() +
  #scale_color_manual(values = c("Wastewater_Daphnia" = "blue", "Wastewater_control" = "red")) +  # Customize colors
  scale_y_continuous(limits = c(0, 600)) +# Set y-axis limits
theme_minimal() +
  theme(
    axis.text.x = element_text(size = 12, angle = 0, vjust = 0.5, hjust = 0.5),  # Increase x-axis text size
    axis.text.y = element_text(size = 12),  # Increase y-axis text size
    legend.text = element_text(size = 10),  # Increase legend text size
    strip.text = element_text(size = 12))  # Increase facet label text size
```



```{r}
# extract the bactterial count data from the phyolseq object

count_matrix <- as.matrix(otu_table(ww_rare.2))
count_matrix

```

```{r}
# Separate samples into two groups based on the presence of Daphnia

sample_data <- as.data.frame(sample_data(ww_rare.2))
daphnia_samples <- sample_data$Treatment == "Wastewater_Daphnia"
control_samples <- sample_data$Treatment == "Wastewater_Control"

```

```{r}
# Calculate the total bacterial count for each sample.

total_count <- colSums(count_matrix)
total_count

```

```{r}

# Calculate the mean bacterial count for each samople group.

mean_daphnia_count <- mean(total_count[daphnia_samples])
mean_control_count <- mean(total_count[control_samples])

```

```{r}
# Calculate the percentage for each bacteria removed by Daphnia.

percentage_removed <- (mean_control_count - mean_daphnia_count) / mean_control_count * 100
```

```{r}
# Print the result.

cat("Percentage of bacteria removed by Daphnia: ", round(percentage_removed, 2), "%\n")

```

```{r}
library(ggplot2)

# Extract the bacterial count data from the phyloseq object
count_matrix <- as.matrix(otu_table(ww_rare.2))

# Separate samples into two groups based on the presence of Daphnia
sample_data <- as.data.frame(sample_data(ww_rare.2))
sample_data$Daphnia <- ifelse(sample_data$Treatment == "With Daphnia", "With Daphnia", "Without Daphnia")

# Calculate the total bacterial count for each sample
sample_data$Total_Count <- colSums(count_matrix)

# Create a box plot
ggplot(sample_data, aes(x = Daphnia, y = Total_Count)) +
  geom_boxplot() +
  labs(x = "Treatment", y = "Total Bacterial Count") +
  theme_minimal()

# Create a histogram with separate panels for each group
ggplot(sample_data, aes(x = Total_Count)) +
  geom_histogram(bins = 30) +
  facet_wrap(~ Daphnia, ncol = 1) +
  labs(x = "Total Bacterial Count", y = "Frequency") +
  theme_minimal()

```

```{r}

# Calculate the IQR and outlier threshold for the "Without Daphnia" group
without_daphnia_counts <- sample_data$Total_Count[sample_data$Daphnia == "Without Daphnia"]
Q1 <- quantile(without_daphnia_counts, 0.25)
Q3 <- quantile(without_daphnia_counts, 0.75)
IQR <- Q3 - Q1
outlier_threshold <- Q3 + 1.5 * IQR

# Identify the outlier samples
outlier_samples <- sample_data$Sample[sample_data$Daphnia == "Without Daphnia" & sample_data$Total_Count > outlier_threshold]

# Print the outlier samples
print(outlier_samples)

```

*********Merged AVS counts with Sequence Data*********

```{r}
#Read in the ASV sequence data.
asv_seqs <- readLines("dna-sequences-250.fasta")



```


```{r}
#Read in the ASV count table 
asv_tab <- read.table("feature-table-250.tsv", header=T, row.names=1)

```


```{r}
# Get the ASV IDs

asv_ids <- paste0(">", row.names(asv_tab))

```

```{r}
# Make a sequence list by combining the IDs and sequences.

#asv_list <- data.frame(ASV = asv_ids, Sequence = asv_seqs)
asv_list <- data.frame(ASV = asv_ids, Sequence = asv_seqs[1:length(asv_ids)])


```

```{r}


# Write out the sequence list to a file.

write.table(asv_list, "ASV_sequence_list.txt", sep = "\t", quote = FALSE, row.names = FALSE, col.names = TRUE)

```








""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
""""Wasteswater Microbiome Analysis""""


"""Fresh Analysis"""""""""""""""""""""""""""""""""""""


# Initial Sample QC Check
```{r}

metadata <- read.csv("MetadataWastewater.csv")
stats <-  read_tsv("read-stats.tsv", show_col_types = FALSE)


```

```{r}

head(metadata)

head(stats)

```

```{r}
#lets give the stats dataframe column names

colnames(stats) = c("sample.id", "input", "filtered","reads_passed-filter", "denoised", "merged", "percentage_merged", "non-chimeric", "percentage_non-chimeric")

```

```{r}
head(stats)

```


```{r}

library(tidyverse)
library(dplyr)
```


```{r}

#join the two dataframes.

ww_data <- left_join(metadata, stats)
ww_data

# save the joined data to a file.

write.csv(ww_data, "ww_data.csv")


```


```{r}
#lets selects samples with atleats more than 1000 reads from non-chimeric reads.

ww_data_filtered <- ww_data %>% 
  filter( `non-chimeric`> 10000) %>%
  select('Replicate','sample.id', 'Genotype', 'Day', 'Treatment', 'non-chimeric')

```

```{r}
ww_data_filtered

```

```{r}

#save the filtered data to a file.

write.csv(ww_data_filtered, "ww_data_filtered.csv")

```

```{r}
# inspecting ASVs and Taxonomy files.

#taxonomy file

taxas <- read_tsv("taxonomy.tsv", show_col_types = FALSE)

#ASV file

asv <- read_tsv("frequency_genus-table.tsv", show_col_types = FALSE)

```

```{r}
problems(asv)
problems(taxas)

```

```{r}
head(taxas)
```



#New analysis
```{r}
# create a phyloseq object from the qiime2 artifacts.

ps_object <- qza_to_phyloseq(
  features = "filtered_table.qza",
  tree = "insertion-tree.qza","taxonomy.qza",
  metadata = "MetData_Pathogen_removal.tsv"
)  

```

```{r}

# print the phyloseq object.

ps_object

```

```{r}
# inspect the phyloseq object.

summary(sample_sums(ps_object))
```

```{r}
# rarefy the phyloseq object to the minimum sample read depth.

set.seed(1234)

# plot the read depth before rarefaction.
plot_read_depth <-  function(ps_object){
  # Extract sample read depths
  read_depths <- sample_sums(ps_object)
  
  # create a data frame with sample names and read depths
  df <- data.frame(Sample = names(read_depths), Read_Depth = read_depths)
  
  # create the plot
  ggplot(df, aes(x = Sample , y = Read_Depth)) +
    geom_bar(stat = "identity", fill = "steelblue") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    labs(x = "Sample", y = "Read Depth", title = "Read Depth Before Rarefaction")
}

# plot the read depth before rarefaction
plot_read_depth(ps_object)

```

```{r}
# Rarefy the phyloseq object to the minimum(even) sample read depth.

ps_object_rarefied <- rarefy_even_depth(ps_object, rngseed = 1234,  sample.size = 22574,
                                        replace = TRUE, verbose = TRUE, trimOTUs = TRUE) # trimOTUs = TRUE removes OTUs with zero counts in all samples.

# plot rarefaction curves with custom color.
set.seed(123)
otu_mat <- t(as(otu_table(ps_object_rarefied), "matrix"))
rarecurve(otu_mat, step = 500, col = "red", cex = 0.8, 
          xlab = "Number of Sequences", ylab = "Number of ASVs", 
          main = "Rarefaction Curves")

```

```{r}
# inspect the rarefied phyloseq object.

table(tax_table(ps_object_rarefied)[, "Phylum"], exclude = NULL)

```


```{r}

# if any of the phylum has only one feature, consider removing it
ps_object_rare_subset <- subset_taxa(ps_object_rarefied, !is.na(Phylum) & !Phylum %in% c("Spirochaetota", "Campilobacterota", "Elusimicrobiota", "NA"))

table(tax_table(ps_object_rare_subset)[, "Phylum"], exclude = NULL)

```
```{r}
# remove features with ambiguous phylum annotation.

ps_object_rare_subset <- subset_taxa(ps_object_rare_subset, !is.na(Phylum) & !Phylum %in% c("", "uncharacterized"))

```

```{r}
#compute the prevalence of each feature and store in a data frame
prevdf_rarefied <- apply(X = otu_table(ps_object_rare_subset),      
                   MARGIN = ifelse(taxa_are_rows(ps_object_rare_subset), yes = 1,   no= 2), # number of samples in which taxa are present at least once.
                   FUN = function(OTU) {sum(OTU > 0)})

```

```{r}
# Add taxonomy and total read counts to the data frame.
prevdf_rarefied <- data.frame(Prevalence = prevdf_rarefied,
                        TotalAbundance = taxa_sums(ps_object_rare_subset),
                        tax_table(ps_object_rare_subset))

prevdf_rarefied

```

```{r}
# Are there phyla that are comprised of low prevalence features?
# compute the total and average prevalence of features in each phylum.

plyr::ddply(prevdf_rarefied, "Phylum",
            function(df1){cbind(mean(df1$Prevalence), sum(df1$Prevalence))})

```

```{r}
# remove features with low prevalence.

filterPhyla <-  c("Fibrobacterota", "Planctomycetota") # phyla with low prevalence features.

# filter entries with unidentified phylum.
ps_object_rare1 <- subset_taxa(ps_object_rare_subset, Phylum %in% filterPhyla)

ps_object_rare1

```

# Prevalence filtering
```{r}
# subset to the remaining phyla.

prevdf_rare1 <- subset(prevdf_rarefied, Phylum %in% get_taxa_unique(ps_object_rare1, "Phylum"))

```

```{r}
ggplot(prevdf_rare1, aes(TotalAbundance, Prevalence / nsamples(ps_object_rare_subset), color = Phylum)) +
  # include a guess for parameter
  
  geom_hline(yintercept = 0.05, alpha = 0.5, linetype = 2) +
  geom_point(size = 2, alpha = 0.7) +
  scale_x_log10() + xlab("Total Abundance") + ylab("Prevalence [Frac. samples]") +
  facet_wrap(~Phylum) +
  theme(legend.position = "none") 
```

```{r}
# define the prevance threshold. as 5% of total sampls.
set.seed(1234)
prevalence_threshold <- 0.05 * nsamples(ps_object_rare_subset)  ## 5% of total samples.
prevalence_threshold  

```
# Note: prevalence filtering is used to remove 
#rare features that are only present in less than half of the samples
```{r}
# Execute prevalence filtering.

keepTaxa <-  rownames(prevdf_rarefied)[(prevdf_rarefied$Prevalence >= prevalence_threshold)]
ps_object_rare2 <- prune_taxa(keepTaxa,ps_object_rare_subset)
ps_object_rare2

```

```{r}
# phyloseq object before filtering
ps_object_rare_subset

```

# Agglomerate taxa
```{r}
# how many genera would be present after filtering?
length(get_taxa_unique(ps_object_rare2, "Genus"))

```

```{r}
# how many family would be present after filtering?
length(get_taxa_unique(ps_object_rare2, "Family"))

```

```{r}
ps_object_rare3 <- tax_glom(ps_object_rare2, "Genus", NArm = TRUE)
ps_object_rare4 <- tax_glom(ps_object_rare2, "Family", NArm = TRUE)

```


# Calculate apha and beta diveristy at varying prevalence thresholds.
```{r}
# define the prevalence thresholds.
prevthreshold <-  c(0.01,0.05, 0.1, 0.2, 0.5)

```

```{r}
# function to calculate alpha and beta diversity metrics.
calc_diversity <- function(prevdf_rarefied, prevthreshold){
 
   # filter taxa based on prevalence threshold.
  ps_object_filtered <- filter_taxa(ps_object_rare_subset, function(x) sum(x > 0) > (prevthreshold * length(x)), TRUE)
  
                        
  
  # calculate alpha diversity
  alpha_div <- estimate_richness(ps_object_filtered, measures = c("Observed", "Shannon", "Simpson"))
  
  # calculate beta diversity
  beta_div <- vegdist(otu_table(ps_object_filtered), method = "bray")
  
  return(list(alpha_div = alpha_div, beta_div = beta_div))
}

```


```{r}
#evaluate the diversity at different prevalence thresholds.
diversity_list <- lapply(prevthreshold, function(threshold) calc_diversity(prevdf_rarefied, threshold))

```

```{r}
# print alpha diversity result.
lapply(diversity_list, function(x) x$alpha_div)

```

```{r}


lapply(diversity_list, function(x) print(summary(as.dist(x$beta_div))))

```

```{r}

# calculate the alpha diversity metrics.

alpha_div <- estimate_richness(ps_object_rare2, measures = c("Observed", "Shannon", "Simpson"))

# plot alpha divresity metrics.
plot_richness(ps_object_rare2, x = "Day", measures ="Simpson") +
  geom_boxplot(aes(fill = Treatment))+ # Add fill color based on Treatment.
  theme_bw() +
  facet_grid(~Genotype) + # facet by Genotype.
  theme(
    axis.text.x = element_text(angle = 90,
                               hjust = 1,
                               vjust = 0.5),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.text = element_text(size = 12)) +# rotate x-axis labels.
 scale_y_continuous(limits = c(0, max(alpha_div$Simpson) * 1.1), # Adjust y-axis limits
                     expand = c(0, 0))
```

```{r}
# calculate beta diversity.

bc_dist <-  phyloseq::distance(ps_object_rare2, method = "bray")

# ordinate using PCoA

ord <-  ordinate(ps_object_rare2, method = "PCoA", distance = bc_dist)

# Plot PCoA

plot_ordination(ps_object_rare2, ord, color = "Treatment", title = "Bray-Curtis PCoA") +
  geom_point(size = 3) +
  
  theme_bw() 
  




```



```{r}

# Calculate Bray-Curtis dissimilarity
bc_dist <- phyloseq::distance(ps_object_rare2, method = "bray")

# Perform PCoA ordination
ord <- ordinate(ps_object_rare2, method = "PCoA", distance = bc_dist)

# Plot PCoA ordination
plot_ordination(ps_object_rare2, ord, color = "Genotype", shape = "Day") +
  facet_grid(~Treatment) +  # Add facet_grid to create separate plots for each Day
  geom_point(size = 5) +
  theme_bw()



```
```{r}

# Calculate Bray-Curtis dissimilarity
bc_dist <- phyloseq::distance(ps_object_rare2, method = "bray")

# Perform PCoA ordination
ord <- ordinate(ps_object_rare2, method = "PCoA", distance = bc_dist)

# Plot PCoA ordination
plot_ordination(ps_object_rare2, ord, color = "Genotype", shape = "Day") +
  geom_point(aes(fill = Treatment), size = 5, stroke = 1) +
  scale_shape_manual(values = c(21, 22, 23)) +  # Different shapes for each Day
  scale_fill_manual(values = c("white", "black")) +  # Fill colors for Treatment
  theme_bw() +
  labs(title = "PCoA of Bray-Curtis Dissimilarity",
       x = "PCoA1", y = "PCoA2") +
  theme(legend.position = "right",
        plot.title = element_text(hjust = 0.5, size = 16),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 10)) +
  guides(color = guide_legend(title = "Genotype"),
         shape = guide_legend(title = "Day"),
         fill = guide_legend(title = "Treatment"))



```

```{r}
library(phyloseq)
library(ggplot2)
library(dplyr)
library(RColorBrewer)
library(microbiome)

# Aplly transformation to the data

ps_object_rare2_transformed <- transform_sample_counts(ps_object_rare2, function(x) x / sum(x)) # Relative abundance.

# Calculate Bray-Curtis dissimilarity
bc_dist <- phyloseq::distance(ps_object_rare2_transformed, method = "bray")


# Perform PCoA ordination
ord <- ordinate(ps_object_rare2_transformed, method = "PCoA", distance = bc_dist)

# Extract the percent variance explained by each axis
variance_explained <- ord$values$Relative_eig * 100

# Create a data frame with the PCoA coordinates and metadata
plot_data <- data.frame(
  PC1 = ord$vectors[,1],
  PC2 = ord$vectors[,2],
  Day = sample_data(ps_object_rare2_transformed)$Day,
  Genotype = sample_data(ps_object_rare2_transformed)$Genotype
)

# Define color palettes for Genotype and Day
genotype_colors <- brewer.pal(n = length(unique(plot_data$Genotype)), name = "Set1")
day_colors <- brewer.pal(n = length(unique(plot_data$Day)), name = "Dark2")

# Plot PCoA ordination
ggplot(plot_data, aes(x = PC1, y = PC2)) +
  geom_point(aes(color = Genotype, shape = Day), size = 5, stroke = 1.5) +
  scale_color_manual(values = genotype_colors) +
  scale_shape_manual(values = c(16, 17, 18)) +
  labs(
    x = paste0("PC1 (", round(variance_explained[1], 2), "%)"),
    y = paste0("PC2 (", round(variance_explained[2], 2), "%)"),
    title = "PCoA of Bray-Curtis Dissimilarity",
    color = "Genotype",
    shape = "Day"
  ) +
  theme_bw() +
  theme(
    legend.position = "right",
    plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),
    axis.title = element_text(size = 16, face = "bold"),
    axis.text = element_text(size = 14),
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 12),
    legend.key.size = unit(1, "cm")
  ) +
  guides(color = guide_legend(override.aes = list(size = 5)),
         shape = guide_legend(override.aes = list(size = 5)))

ggsave("PCoA_Genotype_Day.pdf", width = 10, height = 8, dpi = 300)

```


```{r}
# Weighted Unifrac.
library(phyloseq)
library(ggplot2)
library(dplyr)
library(RColorBrewer)
library(microbiome)

# Apply transformation to the data
ps_object_rare2_transformed <- transform_sample_counts(ps_object_rare2, function(x) x / sum(x)) # Relative abundance

# Calculate weighted UniFrac distance
wunifrac_dist <- phyloseq::distance(ps_object_rare2_transformed, method = "wunifrac")

# Perform PCoA ordination
ord <- ordinate(ps_object_rare2_transformed, method = "PCoA", distance = wunifrac_dist)

# Extract the percent variance explained by each axis
variance_explained <- ord$values$Relative_eig * 100

# Create a data frame with the PCoA coordinates and metadata
plot_data <- data.frame(
  PC1 = ord$vectors[,1],
  PC2 = ord$vectors[,2],
  Day = sample_data(ps_object_rare2_transformed)$Day,
  Genotype = sample_data(ps_object_rare2_transformed)$Genotype
)

# Define color palettes for Genotype and Day
genotype_colors <- brewer.pal(n = length(unique(plot_data$Genotype)), name = "Set1")
day_colors <- brewer.pal(n = length(unique(plot_data$Day)), name = "Dark2")

# Plot PCoA ordination
ggplot(plot_data, aes(x = PC1, y = PC2)) +
  geom_point(aes(color = Genotype, shape = Day), size = 5, stroke = 1.5) +
  scale_color_manual(values = genotype_colors) +
  scale_shape_manual(values = c(16, 17, 18)) +
  labs(
    x = paste0("PC1 (", round(variance_explained[1], 2), "%)"),
    y = paste0("PC2 (", round(variance_explained[2], 2), "%)"),
    title = "PCoA of Weighted UniFrac Distance",
    color = "Genotype",
    shape = "Day"
  ) +
  theme_bw() +
  theme(
    legend.position = "right",
    plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),
    axis.title = element_text(size = 16, face = "bold"),
    axis.text = element_text(size = 14),
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 12),
    legend.key.size = unit(1, "cm")
  ) +
  guides(color = guide_legend(override.aes = list(size = 5)),
         shape = guide_legend(override.aes = list(size = 5)))

ggsave("PCoA_Weighted_UniFrac_Genotype_Day.pdf", width = 10, height = 8, dpi = 300)



```



```{r}
 #Permutation test for differences between treatments

bc_adonis <- adonis(bc_dist ~ get_variable(ps_object_rare2, "Genotype"))
bc_adonis

```











```{r}
merge_less_than_top_ps <- function(ps_object_rare2, top = 15) { transformed <- transform_sample_counts(ps_object_rare2, function(OTU) OTU/sum(OTU)) 
otu.table <- as.data.frame(otu_table(transformed))
otu.sort <- otu.table[order(rowMeans(otu.table), decreasing = TRUE),]
otu.list <- row.names(otu.sort[(top + 1):nrow(otu.sort),])
merged <- merge_taxa(transformed, otu.list, 1)
for (i in 1:dim(tax_table(merged))[1]){
  if (is.na(tax_table(merged)[i,2])){
    taxa_names(merged)[i] <- "Other"
    tax_table(merged)[i, 1:6] <- "other"
  }
}
return(merged) 
}

```


```{r}
ps_gen <- tax_glom(ps_object_rare2, "Genus", NArm = TRUE)
ps_family <- tax_glom(ps_object_rare2, "Family", NArm = TRUE)


```

```{r}
# Merge less than top 15 genera and families
ps_Gen_15 <- merge_less_than_top_ps(ps_gen, top = 15)
pf_family_15 <- merge_less_than_top_ps(ps_family, top = 15)

```

```{r}
# convert to dataframe
df_gen_top15 <- psmelt(ps_Gen_15) %>%
  filter(Abundance > 0) %>%
  arrange(Genus)
df_family_top15 <- psmelt(pf_family_15) %>%
  filter(Abundance > 0) %>%
  arrange(Family)

```

```{r}
#save the data
write.csv(df_gen_top15, "genus_top15.csv")
write.csv(df_family_top15, "family_top15.csv")

```

```{r}

df_gen_top15 
```

```{r}

df_family_top15

```





```{r}
library(ggplot2)
library(viridis)  # For a more vibrant color palette

gen_10 <- ggplot(
  df_gen_top15, aes(x = Day, y = Abundance, fill = Genus)
) +
  facet_grid(~Genotype, scales = "free") +
  geom_bar(stat = "identity", position = "fill") +
  labs(x = "Day", y = "Relative Abundance", title = "Genus Relative Abundance") +
  scale_fill_viridis(discrete = TRUE, option = "turbo") +  # More vibrant color palette
  theme_minimal() +  # Cleaner background
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    axis.title = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(size = 12, angle = 90, vjust = 0.5, hjust = 1),
    axis.text.y = element_text(size = 12),
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 10),
    strip.text = element_text(size = 14, face = "bold"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "bottom"
  ) +
  guides(fill = guide_legend(ncol = 3))  # Adjust legend layout

# Increase plot size
ggsave("genus_relative_abundance.png", gen_10, width = 15, height = 10, dpi = 300)

# Display the plot
print(gen_10)


```

```{r}
family_15 <- ggplot(
  df_family_top15, aes(x = Day, y = Abundance, fill = Family)
) +
  facet_grid(~Genotype, scales = "free") +
  geom_bar(stat = "identity", position = "fill") +
  labs(x = "Day", y = "Relative Abundance", title = "Family Relative Abundance") +
  scale_fill_viridis(discrete = TRUE, option = "turbo") +  # More vibrant color palette
  theme_minimal() +  # Cleaner background
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    axis.title = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(size = 12, angle = 90, vjust = 0.5, hjust = 1),
    axis.text.y = element_text(size = 12),
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 10),
    strip.text = element_text(size = 14, face = "bold"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "bottom"
  ) +
  guides(fill = guide_legend(ncol = 3))  # Adjust legend layout

# Increase plot size
ggsave("Family_relative_abundance.png", gen_10, width = 15, height = 10, dpi = 300)

# Display the plot
print(family_15)

```

```{r}
# compute test for group differences.
# create a new variable representing the combination of Genotype and Replicates.

sample_data(ps_object_rare2_transformed)$Genotype_Replicates <- interaction(sample_data(ps_object_rare2_transformed)$Genotype,sample_data(ps_object_rare2_transformed)$Replicates)



```


```{r}
# Test for group differences using adonis with the interaction term and strata.

adonis_result <-  adonis(
  wunifrac_dist ~ Genotype * Day, data = as(sample_data(
    ps_object_rare2_transformed
  ), "data.frame"),
  strata = sample_data(ps_object_rare2_transformed)$Genotype_Replicates
)  # Adonis test with interaction term and strata


```
```{r}
adonis_result

```

```{r}
# Extract the adonis results.

library(openxlsx)
adonis_table <- adonis_result$aov.tab

# create a new workbook and aad a new worksheet.

wb <- createWorkbook()
addWorksheet(wb, "Adonis Results")

# Write the adonis results to the worksheet.

writeData(wb, "Adonis Results", adonis_table)

# Save the workbook to a file.

saveWorkbook(wb, "adonis_results.xlsx", overwrite = TRUE)

```

```{r}
merge_less_than_threshold <- function(ps_object_rare2, threshold = 0.01) {
  transformed <- transform_sample_counts(ps_object_rare2, function(OTU) OTU/sum(OTU))
  otu.table <- as.data.frame(otu_table(transformed))
  
  # Identify taxa below threshold
  taxa_to_merge <- rownames(otu.table)[rowMeans(otu.table) < threshold]
  
  merged <- merge_taxa(transformed, taxa_to_merge, 1)
  
  for (i in 1:dim(tax_table(merged))[1]){
    if (taxa_names(merged)[i] == "merged"){
      taxa_names(merged)[i] <- "Other"
      tax_table(merged)[i, 1:6] <- "Other"
    }
  }
  
  return(merged)
}


```


```{r}

genus_df <- tax_glom(ps_object_rare2, "Genus", NArm = TRUE)



```


```{r}
# Filter out low abundance genera

ps_merged <- merge_less_than_threshold(genus_df, threshold = 0.01)

```


```{r}

# convert to dataframe
gen_top <- psmelt(ps_merged) %>%
  filter(Abundance > 0) %>%
  arrange(Genus)

```

```{r}
library(ggplot2)
library(viridis)  # For a more vibrant color palette

gen <- ggplot(
  gen_top, aes(x = Day, y = Abundance, fill = Genus)
) +
  facet_grid(~Genotype, scales = "free") +
  geom_bar(stat = "identity", position = "fill") +
  labs(x = "Day", y = "Relative Abundance", title = "Genus Relative Abundance") +
  scale_fill_viridis(discrete = TRUE, option = "turbo") +  # More vibrant color palette
  theme_minimal() +  # Cleaner background
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    axis.title = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(size = 12, angle = 90, vjust = 0.5, hjust = 1),
    axis.text.y = element_text(size = 12),
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 10),
    strip.text = element_text(size = 14, face = "bold"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "bottom"
  ) +
  guides(fill = guide_legend(ncol = 3))  # Adjust legend layout

# Increase plot size
ggsave("genus_relative_abundance.png", gen, width = 15, height = 10, dpi = 300)

# Display the plot
print(gen)




```


```{r}
library(dplyr)
library(tidyr)
library(knitr)

# Ensure we're using dplyr functions
genus_stats <- df_gen_top15 %>%
  dplyr::group_by(Genus, Genotype) %>%
  dplyr::summarise(
    Mean_Abundance = mean(Abundance),
    SE_Abundance = sd(Abundance) / sqrt(dplyr::n()),
    .groups = "drop"
  ) %>%
  dplyr::arrange(Genotype, desc(Mean_Abundance))

# Format the table
genus_table <- genus_stats %>%
  dplyr::mutate(
    Mean_Abundance = sprintf("%.4f", Mean_Abundance),
    SE_Abundance = sprintf("%.4f", SE_Abundance)
  )

# Print the table
kable(genus_table, 
      col.names = c("Genus", "Genotype", "Mean Relative Abundance", "Standard Error"),
      caption = "Top 15 Genera by Mean Relative Abundance")

# Save the table to a CSV file
write.csv(genus_table, "top_15_genera_abundance.csv", row.names = FALSE)

```


```{r}
library(dplyr)
library(tidyr)
library(knitr)

# Calculate mean and standard error for each genus across Genotypes and Days
genus_stats <- df_gen_top15 %>%
  dplyr::group_by(Genus, Genotype, Day) %>%
  dplyr::summarise(
    Mean_Abundance = mean(Abundance),
    SE_Abundance = sd(Abundance) / sqrt(dplyr::n()),
    .groups = "drop"
  ) %>%
  dplyr::arrange(Genotype, Day, desc(Mean_Abundance))

# Format the table
genus_table <- genus_stats %>%
  dplyr::mutate(
    Mean_Abundance = sprintf("%.4f", Mean_Abundance),
    SE_Abundance = sprintf("%.4f", SE_Abundance)
  )

# Print the table
kable(genus_table, 
      col.names = c("Genus", "Genotype", "Day", "Mean Relative Abundance", "Standard Error"),
      caption = "Top 15 Genera by Mean Relative Abundance across Genotypes and Days")

# Save the table to a CSV file
write.csv(genus_table, "top_15_genera_abundance_by_genotype_and_day.csv", row.names = FALSE)


```

```{r}
library(phyloseq)
library(ggplot2)
library(dplyr)

# Assuming ps_merged is your phyloseq object after merging low abundance taxa

# Convert to relative abundance
ps_rel <- transform_sample_counts(ps_merged, function(x) x / sum(x))

# Melt the phyloseq object to a long format
ps_melted <- psmelt(ps_rel)

# Select the top 15 most abundant genera
top_15_genera <- ps_melted %>%
  group_by(Genus) %>%
  summarise(mean_abundance = mean(Abundance)) %>%
  arrange(desc(mean_abundance)) %>%
  top_n(15, mean_abundance) %>%
  pull(Genus)

# Filter the melted data for the top 15 genera
ps_top15 <- ps_melted %>%
  filter(Genus %in% top_15_genera)

# Create boxplot
ggplot(ps_top15, aes(x = Genus, y = Abundance, fill = Genotype)) +
  geom_boxplot() +
  facet_wrap(~Day, scales = "free_y") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Genus", y = "Relative Abundance", 
       title = "Relative Abundance of Top 15 Genera by Genotype and Day") +
  scale_y_continuous(labels = scales::percent)

# Save the plot
ggsave("top_15_genera_boxplot.png", width = 15, height = 10, dpi = 300)

```














#differential abundance analysis
```{r}
library(ANCOMBC)
library(phyloseq)
library(tidyverse)

# Perform ANCOM-BC analysis
ancombc_result <- ancombc(phyloseq = ps_merged, 
                          formula = "Genotype + Day", 
                          p_adj_method = "holm",
                          zero_cut = 0.90, # prevalence filter
                          lib_cut = 1000, # library size filter
                          group = "Genotype", 
                          struc_zero = TRUE, 
                          neg_lb = TRUE, 
                          tol = 1e-5, 
                          max_iter = 100, 
                          conserve = TRUE, 
                          alpha = 0.05, 
                          global = FALSE)

# Extract results
res <- ancombc_result$res






```



